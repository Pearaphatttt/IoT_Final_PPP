<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DHT Realtime Dashboard</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Prompt,TH Sarabun New,Arial;background:#0b0f17;color:#e5e7eb}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    #status{color:#9ca3af;margin-bottom:16px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{border:1px solid #374151;border-radius:16px;padding:16px;background:#111827}
    .label{font-size:14px;color:#9ca3af;margin-bottom:4px}
    .value{font-size:40px;font-weight:800}
    .card.chart-card{height:auto}

    .chart-wrap{position:relative;height:260px}
    .chart-wrap canvas{display:block;width:100% !important;height:100% !important}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>DHT Realtime Dashboard</h1>
    <div id="status">กำลังเชื่อมต่อ…</div>

    <div class="grid">
      <div class="card">
        <div class="label">Temperature (°C)</div>
        <div class="value" id="temp">--</div>
        <div class="label">อัปเดตล่าสุด: <span id="updated">--</span></div>
      </div>
      <div class="card">
        <div class="label">Humidity (%)</div>
        <div class="value" id="hum">--</div>
      </div>
      <div class="card">
        <div class="label">Distance (cm) — Ultrasonic</div>
        <div class="value" id="dist">--</div>
      </div>
      <div class="card">
        <div class="label">Light (lux) — BH1750</div>
        <div class="value" id="lux">--</div>
      </div>
    </div>

    <div class="card chart-card" style="margin-top:16px">
      <div class="label">Temperature (30 จุดล่าสุด)</div>
      <div class="chart-wrap">
        <canvas id="chartTemp"></canvas>
      </div>
    </div>

    <div class="card chart-card" style="margin-top:16px">
      <div class="label">Distance (30 จุดล่าสุด)</div>
      <div class="chart-wrap">
        <canvas id="chartDist"></canvas>
      </div>
    </div>

    <div class="card chart-card" style="margin-top:16px">
      <div class="label">Light (Lux) — 30 จุดล่าสุด</div>
      <div class="chart-wrap">
        <canvas id="chartLux"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey:       "AIzaSyDl8rqmcgSoCXnJO28PCO5Ntvvo16bz1AE",
      authDomain:   "testexsamplefinaliot01.firebaseapp.com",
      databaseURL:  "https://testexsamplefinaliot01-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:    "testexsamplefinaliot01",
      appId:        "1:301574166269:web:754c3eb0f39adc48065094"
    };

    // ใช้ Anonymous Auth (เปิดใน Console ด้วย)
    const USE_ANON_AUTH = true;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const auth = getAuth(app);

    const statusEl  = document.getElementById("status");
    const tempEl    = document.getElementById("temp");
    const humEl     = document.getElementById("hum");
    const distEl    = document.getElementById("dist");
    const luxEl     = document.getElementById("lux");
    const updatedEl = document.getElementById("updated");

    const canvasTemp = document.getElementById("chartTemp");
    const canvasDist = document.getElementById("chartDist");
    const canvasLux  = document.getElementById("chartLux");

    let tempChart, distChart, luxChart;
    let labels = [], temps = [], dists = [], luxs = [];

    function start() {
      statusEl.textContent = "เชื่อมต่อแล้ว • กำลังฟังข้อมูล…";

      // อ่านค่าปัจจุบันที่ /latest
      onValue(ref(db, `/latest`), snap => {
        const v = snap.val(); if (!v) return;
        const t = Number(v.temperature), h = Number(v.humidity), d = Number(v.distance), lx = Number(v.lux);
        tempEl.textContent = Number.isFinite(t) ? t.toFixed(1) : "--";
        humEl.textContent  = Number.isFinite(h) ? h.toFixed(1) : "--";
        distEl.textContent = Number.isFinite(d) ? d.toFixed(1) : "--";
        luxEl.textContent  = Number.isFinite(lx)? lx.toFixed(1): "--";
        if (v.ts) updatedEl.textContent = new Date(Number(v.ts)).toLocaleString();
      });

      // อ่านประวัติที่ /history (30 จุดล่าสุด)
      const q = query(ref(db, `/history`), limitToLast(30));
      onValue(q, snap => {
        const obj = snap.val() || {};
        const items = Object.keys(obj).sort((a,b)=>Number(a)-Number(b))
          .map(k => ({ ts:+k, ...obj[k] }));

        console.log("history items:", items.length, items.slice(-3)); // debug

        labels = items.map(i => new Date(i.ts).toLocaleTimeString());
        temps  = items.map(i => Number(i.temperature));
        dists  = items.map(i => Number(i.distance));
        luxs   = items.map(i => Number(i.lux));
        render();
      });
    }

    function makeLineChart(canvasEl, label, data){
      return new Chart(canvasEl.getContext("2d"), {
        type:"line",
        data:{ labels, datasets:[{ label, data, tension:.25, pointRadius:2 }] },
        options:{
          responsive:true,
          maintainAspectRatio:false, // ใช้ความสูงจาก .chart-wrap
          scales:{
            x:{ ticks:{ color:"#9ca3af" }, grid:{ color:"#1f2937" } },
            y:{ ticks:{ color:"#9ca3af" }, grid:{ color:"#1f2937" } }
          },
          plugins:{ legend:{ labels:{ color:"#e5e7eb" } } },
          animation:false
        }
      });
    }

    function render(){
      if (tempChart) tempChart.destroy();
      if (distChart) distChart.destroy();
      if (luxChart)  luxChart.destroy();
      tempChart = makeLineChart(canvasTemp, "Temperature (°C)", temps);
      distChart = makeLineChart(canvasDist, "Distance (cm)", dists);
      luxChart  = makeLineChart(canvasLux,  "Light (lux)",     luxs);
    }

    if (USE_ANON_AUTH){
      statusEl.textContent = "กำลังลงชื่อเข้าใช้แบบ Anonymous…";
      signInAnonymously(auth).catch(err=>{
        statusEl.textContent = "Anonymous Auth ล้มเหลว: " + err.message;
        console.error(err);
      });
      onAuthStateChanged(auth, (u)=>{ if (u) start(); });
    } else {
      start(); // ต้องตั้ง Rules ".read": true ชั่วคราว
    }
  </script>
</body>
</html>
